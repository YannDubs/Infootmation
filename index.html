<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta name="og:title" content="Infootmation: European football players visualisation">
    <meta name="og:description" content="A visualization of interesting statistics for football players of the biggest euopean leagues.">
    <meta name="og:image" content="img/desc_img.png">
    <title>Infootmation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Yann Dubois">
    <link rel="apple-touch-icon" sizes="60x60" href="img/favicon.png">
    <link rel="icon" sizes="60x60" href="img/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">



    <!-- BOOTRSTAP CDN -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link href="styles/jquery.ui.1.10.0.ie.css" rel="stylesheet"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <link rel="stylesheet" href="styles/dc.min.css" type="text/css">
    <link rel="stylesheet" href="styles/radar-chart.css" type="text/css">



    <!-- Le styles -->
    <Link  rel="stylesheet" href="styles/main.css" type="text/css">  
   
  </head>

  <body>

    <!-- ################# HEADER ################# -->
    <div class="navbar navbar-inverse navbar-fixed-top" id="my-navbar" role="navigation">

      <div class="container">

        <div class="navbar-header ">
          <a class="navbar-brand" onClick="window.location.reload()">
            <img src="img/T3.png" width="207" height="25" alt="">
          </a>
        </div>
       
        <div class="navbar-search pull-right navbar-form">
          <div class="input-group">
            <input id='player_search_box' type="text" class="autocomplete form-control mr-sm-2" placeholder="Player" >

            <div id='player_search_button' class="input-group-btn" data-toggle="buttons" >
              <label id='player_search_submit' class="btn btn-default my-2 my-sm-0" onclick="updateAll(); ">
                <i class="glyphicon glyphicon-search"></i>
              </label>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="container-fluid">

      <!-- ################# CHART ################# -->
         <div class="row">
      		<div class="col-lg-2 col-md-3 col-sm-6 col-xs-12>">
	      		<div class="center-block textBox" style="width:177px;">
	            	<h1 id="playerNameHeader" style="font-size:23px;font-weight: bold;">Robert Lewandowski</h1>
	            	<image class="imageChild" id="playerPicture" x=0 y=0 src='http://cdn.sofifa.org/17/players/188545.png'></image>
	            	
	            	<select id = "selectYear" class="form-control selectpicker">
	            	  <option>2014/2015</option>
	            	  <option selected>2015/2016</option>
	            	  <option>All</option>
	            	</select>

	      	  	</div>
      	  	</div>
      
      		<div class="col-lg-10 col-md-9 col-sm-6 col-xs-12>">
      			<div class="row center-block" style="padding-top: 27px;">
		      		<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 center-block elementContains" height=307 width=317 >
		      			<div class="center-block elementBelow" >
			      			<svg id="silhouette" height=307 width=317>	
			      				<text id="textPercentage" x="37.7%" y="4%" font-size = "17" > Percentage of goals </text>
			       		  		<image x="47%" y="53%" height=267 width=317 transform="translate(-157.66,-133.5)" xlink:href='img/silhouette2.svg'></image>
			      		  		<circle class = "circleHover" id ="shotCircle" cx="173" cy="237" r="1" fill="#238bbc" opacity="0.97" stroke="rgb(8, 29, 88)" stroke-width = "0px"/>
			      		  		<circle class = "circleHover" id ="headerCircle" cx="133" cy="57" r="1" fill="#238bbc" opacity="0.97" stroke="rgb(8, 29, 88)" stroke-width = "0px" />
			      		  		<text id="headerPercentageText" x="133" y="57" font-size = "17" text-anchor="middle" style = "pointer-events: none; fill: white;"> </text>
			      		  		<text class="textUnits" id="headerPercentageUnit" x="133" y="69" font-size = "13" text-anchor="middle" style = "pointer-events: none; fill: white;"> </text>
			      		  		<text id="shotPercentageText" x="174.7" y="237" font-size = "17" text-anchor="middle" style = "pointer-events: none; fill: white;"> </text>
			      		  		<text class="textUnits" id="shotPercentageUnit" x="174.7" y="249" font-size = "13" text-anchor="middle" style = "pointer-events: none; fill: white;"> </text>
			      		  		<text id="playerHeight" x="0" y="53%" font-size = "17" > 185cm</text>
			      		  		<text id="playerWeight" x="47%" y="303" font-size = "17" > 79kg</text>
								<g id="circlesLegend"> </g>
								<image class="elementAbove helpHoverOver" x="63%" y="59.7%" height=87 width=87  xlink:href='img/hoverOverDown.svg' style = "pointer-events: none;" ></image>
							</svg>	
						</div>

						<div class="elementAbove" >
			      			<button id="togglePercentage" type="button" class="btn btn-default"  onclick="this.blur(); updatePercentage();  ">On target</button>
		      			</div>
		      		</div>

		      		<div class = "col-lg-6 col-md-6 col-sm-12 col-xs-12 center-block " style="padding-top: 17px; padding-bottom: 17px;">	
		      			<div class="center-block elementBelow" >
		      				<div class="center-block" id="chart"  height=307 width=317  ></div>
		      			</div>

		      			<div class="elementAbove" >
			      			<select id = "selectRadar" class="form-control selectpicker" style="margin-top:-111px;margin-left:-43px;width:93px;">
			      			  <option>Best 5</option>
			      			  <option selected>General</option>
			      			  <option>Worst 5</option>
			      			</select>
		      			</div>

		      			<div class="elementAbove" style="pointer-events: none; " >
			      			<h3 style="margin-left:-207px;margin-top:-27px;font-size: 15px;color: rgb(36, 144, 189);">
			      			  Player
			      			</h3>
			      			<h3 style="margin-left:-207px;margin-top:-5px;font-size: 15px;color: rgb(196, 232, 180);">
			      			  Average
			      			</h3>
		      			</div>


		      		</div>
		      	</div>

		      	<div class="row center-block" style="padding-top: 17px; padding-bottom: 17px; ">
		      		<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 center-block text-center"  height=307 width=317 >
			      		<h2 style="font-size: 7;" >Most scored against</h2>
			      		<div id="chartGoalTeam" class="elementBelow"></div>
			      		
					</div>

		      		<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 center-block" >
		      			
			      		<svg id="pitch" width=387 height=200>
			      		  <image  x=0 y=0 width=387 height=200 xlink:href='img/half_pitch.svg'></image>
			      		  <g id="heatShots"> </g>
			      		  <g id="goals"> </g>
			      		  <g id="textGoals" style="font-size: 11;" text-anchor="middle"> 
				      		  <text id="vsTextGoals" x="79.7%" y="67.7%"  style="font-weight: bold;" ></text>
				      		  <text id="timeTextGoals" x="79.7%" y="74.7%" ></text>
				      		  <text id="dateTextGoals" x="79.7%" y="81.7%"  ></text>
				      		  <text id="typeTextGoals" x="79.7%" y="88.7%" ></text>
			      		  </g>
			      		  <image class="elementAbove helpHoverOver" x="16.7%" y="29.7%" height=87 width=87  xlink:href='img/hoverOverUp.svg' style = "pointer-events: none;" ></image>

			      		</svg>

			      		<button id="toggleHideGoals" type="button" class="btn btn-default" style="margin-left:19px;width:347px;" onclick="this.blur(); updateHideGoals();  ">Hide goals</button>
		
			      		<!--<select id="selectPositionShots" class="form-control selectpicker" style="margin-left:19px;width:347px;" >
			      		  <option selected>Goals</option>
			      		  <option> Off target </option>
			      		  <option> Blocked Shots</option>
			      		  <option> All </option>
			      		</select>-->
			      	
			      		

					</div>
		      	</div>
      		</div>
      </div>   

	  

      <!-- image from : http-//www.clipartpanda.com/categories/soccer-player-clipart can use freely-->

      <!-- <div id='player_search_container' class='row'>
          <input id='player_search_box' type="text" class="form-control" placeholder="Player" aria-describedby="sizing-addon2">

          <div id='player_search_button' class="btn-group" data-toggle="buttons" >
            <label id='player_search_submit' class="btn btn-primary active " onclick="updateAll()">
              <input type="radio" name="options" id="" autocomplete="off" checked > Search
            </label>
          </div>
      </div> -->
       

      <!-- ################# FOOTER ################# -->
      <hr>
      <footer class="main-footer">
          

          <div class="text-center center-block">
                      <a href="http://www.yourlink.com"><img src="img/infootmation.png" width="97" height="13" alt="" /></a>
                       &copy; <a href="https://github.com/YannDubs">Yann Dubois</a>, 2017 
          </div>

      </footer>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <script type="text/javascript" src="scripts/d3.js"></script>
    <script type="text/javascript" src="scripts/d3-color.min.js"></script>
    <script type="text/javascript" src="scripts/d3-interpolate.min.js"></script>
    <script type="text/javascript" src="scripts/d3-scale.min.js"></script>
    <script type="text/javascript" src="scripts/d3-scale-chromatic.min.js"></script>
    <script type="text/javascript" src="scripts/crossfilter.js"></script>
    <script type="text/javascript" src="scripts/dc.min.js"></script>

    <script src="scripts/jquery-3.1.1.min.js"></script>
      <script src="scripts/jquery-ui.min.js" ></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>    
    <!-- <script type="text/javascript" src="scripts/typeahead.bundle.js"></script>-->

   <script type="text/javascript" src="scripts/radar-chart.js"></script>

    <script type="text/javascript">
    'use strict';  

    // ############################# GLOBAL VARIABLES #############################
    // ########## PARAMETERS ##########
    // stardard size that will be using:
    var stdHeight=307 
    var stdWidth=317
    // intital percentage parameter with default to goal
    var typePercentage = (typeof typePercentage  !== 'undefined') ? typePercentage : "goalPercentage";
    // initiall season: 2015/2016
    var season = (typeof season !== 'undefined') ? season : "2015/2016";
    // initial type goals: goals
    //var typeShots = (typeof typeShots !== 'undefined') ? typeShots : "goal";
    // initial type radar: default
    var typeRadar = (typeof typeRadar !== 'undefined') ? typeRadar : "General";
   
    // ########## CROSSFILTER ##########
    var arrayHeader ;
    var arrayShot ;
    var crossPlayers = [];
    var crossIncidents = [];
    var seasonIncDimension ;
    var playerDimension ;
    var playerIncDimension ;
    var typeDimension ;
    var againstDimension  ;
    var subtypeDimension ;
    var idIncDimension;
    var teamGroup ;
    var averagePlayer = new Object();
    var chartTest;

    // ########## PLAYER ##########
    // ROnaldo : 30893 / Lewandowski : 93447 / MEssi: 30981
    // intital player iwth default
    var playerID = (typeof playerID !== 'undefined') ? playerID : 93447;
    // names for auto complete
    var allNames = [];

    // ########## PITCH ##########
    var heightPitchImage = 200;
    var widthPitchImage = 387;
    var heightPitchReal = 105;
    var widthPitchReal = 68;
    var marginWidthLeft = 66/1160*widthPitchImage;
    var marginWidthRight = 67/1160*widthPitchImage;
    var marginHeightBegin = 53/600*heightPitchImage;
    var marginHeightEnd = 9/600*heightPitchImage;
    var pitchScaleHeight = d3.scale.linear()
                                .domain([0,heightPitchReal/2])
                                .range([marginHeightBegin,heightPitchImage-marginHeightEnd]);
    var pitchScaleWidth = d3.scale.linear()
                                .domain([0,widthPitchReal])
                                .range([marginWidthLeft,widthPitchImage-marginWidthRight]);

    // ########## PERCENTAGE GOALS CIRCLE ##########
    // ### RADIUS SCALE ### what we really see is the area which is proportional to square
    // uses square root because 
    // absolute max / min: trial and error to see what's good
    var minRadius = 3;
    var maxRadius = 57;
    // last time checked the max total shot + header was cristiano ronaldo with 234 => use 237 (more and nice nuber)
    var maxShots = 237;
    var goalScaleRadius = d3.scale.sqrt()
                                .domain([1,maxShots])
                                .range([minRadius,maxRadius]);

    // ### HUE SCALE ###
    //var goalScaleHue = function(invT) { return d3.interpolateInferno(1-invT); };
    //var goalScaleHue = d3.interpolateYlGnBu;
    //var goalScaleHue = function(noScaleT) {return d3.interpolateYlGnBu(Math.pow(noScaleT,0.47));};
    var goalScaleHue = function(noScaleT) {return d3.interpolateYlGnBu(noScaleT*2.7);};
    //var goalScaleHue = function(noScaleT) {return d3.interpolateYlOrRd(noScaleT*2.7);};
    var targetScaleHue = function(noScaleT) {return d3.interpolateYlGnBu(noScaleT/0.37-0.97);};
    var colorFnc = function(index){ return goalScaleHue(0.23-0.14*index);};

    // ### TRANSPARENCY SCALE ###
    var goalScaleTransparency = function(noScaleT) {return 0.67 + noScaleT*0.33;};
    var goalScaleTransparencyInvert = function(toInvert) {return (toInvert-0.67)/0.33 ;};
    	

    // ############################# FUNCTIONS #############################
    // ########## HELP FUNCTIONS ########## 
    function toTitleCase(str) {
      return str.toLowerCase().split(' ').map(function(word) {
        return (word.charAt(0).toUpperCase() + word.slice(1));
      }).join(' ');
    }

    function print_filter(filter) {
        var f=eval(filter);
        if (typeof(f.length) != "undefined") {}else{}
        if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
        if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
        console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
    }

    function top3Bins(source_group) {
        // takes top 5, bit if equality keeeps more

        return {
          // iterates through each object and puts it back in JSON
            all:function () {
                var maxCounter = 3;
                var counter = 0;
                var lastValue = 0;
                // sorts the values and returns top 10
                // SHOULD BE OPTIMIZED: don't sort all!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                return source_group.all().sort(function(a, b) {
                  return parseFloat(b.value) - parseFloat(a.value);
                }).filter(function (d){
                  if (counter < maxCounter || d.value === lastValue){
                    ++counter;
                    lastValue = d.value;
                    return true;
                  } else {
                    // SHOULD BE OPTIMIZED: don't go through all because sorted !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 
                    return false;
                  }
                });
            }
        };
    }

    function removeEmptyBins(source_group) {
        return {
            all:function () {
                return source_group.all().filter(function(d) {
                    return d.value != 0;
                });
            }
        };
    }

    // Parse the date / time
    var parseDate = d3.time.format("%Y-%m-%d").parse
    var formatDate = d3.time.format("%d %b %Y")

    function transformHalfPitch(lat){
      if(lat > heightPitchReal/2){
        return heightPitchReal-lat;
      }
      return lat;
    }

    function crossfilterToRadarDefault(dimension,variables,wholeData) {
      var data = [];
      var average = [];
      $.each(dimension.top(Infinity)[0], function(index, value) {
          if(variables.indexOf(index) > -1) {
            data.push({axis: index, value: value});
            var meanIndex = Math.round(averagePlayer[index]);
            average.push({axis: index, value: meanIndex });
          }
      }); 
      return [data,average];
    }

    function crossfilterToRadarDelta(dimension,wholeData,type) {
      var factorBest = (type === "Best 5") ? 1 : -1;
      var data = [{axis: "", value: 0, delta:0, averageValue:0 },
      			  {axis: "", value: 0, delta:0, averageValue:0 },
      			  {axis: "", value: 0, delta:0, averageValue:0 },
      			  {axis: "", value: 0, delta:0, averageValue:0 },
      			  {axis: "", value: 0, delta:0, averageValue:0 }];
      var currentDelta;
      var averageFive = [];
      var meanValue ;
      var playerFive = [];
      
      $.each(dimension.top(Infinity)[0], function(index, value) {
      	  if(value<=100 && value >= 0){
      	  	//show only what is possible on chart
      	  	meanValue = Math.round(averagePlayer[index]);
      	  	currentDelta = factorBest*(value - meanValue);
      	  	if (currentDelta > data[0].delta){
      	  		// if bigger than the smallest
      	  		data[0].delta = currentDelta;
      	  		data[0].averageValue = meanValue;
      	  		data[0].axis = index;
      	  		data[0].value = value;
      	  		// sort the objects
      	  		data.sort(function(a,b){ return ((a.delta < b.delta) ? -1 : ((a.delta == b.delta) ? 0 : 1));});
      	  	}
      	  }
          
      }); 

      for (var i = 0; i < data.length; i++) {
          playerFive.push({axis: data[i].axis, value: data[i].value});
          averageFive.push({axis: data[i].axis, value: data[i].averageValue });
      }

      return [playerFive,averageFive];
    }

    // ##########  DRAW FUNCTIONS ##########  
    function drawRadar(dimension,averagePlayer) {

      var config = {
      	factorLegend: 1.01,
        w: stdWidth,
        h: stdHeight,
        maxValue: 100,
        factor: 0.83,
        color: colorFnc
        //levels: 6,
        //ExtraWidthX: 300
      }

      if (typeRadar === "General"){

      	var axisVar = ["overall_rating","finishing","dribbling","acceleration","positioning"];

      	RadarChart.draw("#chart", crossfilterToRadarDefault(dimension,axisVar,averagePlayer), config );

      } else {
      	RadarChart.draw("#chart", crossfilterToRadarDelta(dimension,averagePlayer,typeRadar), config );
	  }

      

      //d3.selectAll(".radar-chart .axis .legend").style("font-size","13px")
    }

     function drawGoals(dimension) {
     	//### DRAW HEAT MAP
     	// resets filter for drawing heat map
       dimension.filterAll();
       
       // computes total goal percentage for color
       
       var goalPercentage =  (arrayHeader[0].value + arrayShot[0].value)/ 
       					  (arrayHeader[0].value + arrayHeader[1].value + arrayHeader[2].value +   
       					   arrayShot[0].value + arrayShot[1].value + arrayShot[2].value)
       

       var heatShots = d3.select("#heatShots").selectAll("circle")
		            .data(dimension.top(Infinity))
		            .enter()
		            .append('circle')
		            
		heatShots.attr("cx", function (d) { return pitchScaleWidth( d.lon); })
		            .attr("cy", function (d) { return pitchScaleHeight(transformHalfPitch(d.lat)); })
		            .attr('opacity', '0.17')
		            .attr('r', '7')
		            .attr("pointer-events","none")
		            .attr("fill", goalScaleHue(goalPercentage));

		// ### DRAW GOALS ###
       dimension.filterExact("goal");

       var goalBalls = d3.select("#goals").selectAll("image")
                                 .data(dimension.top(Infinity))
                                 .enter()
                                 .append('image');

      goalBalls
       .attr("x", function (d) { return pitchScaleWidth( d.lon); })
       .attr("y", function (d) { return pitchScaleHeight(transformHalfPitch(d.lat)); })
       .attr('xlink:href',"img/ball.png")
       .attr('width', '17')
       .attr('height', '17')
       .attr('transform', 'translate(-8.5,-8.5)')
       .attr('opacity', '0.9')
       .attr('id', function (d) { return d.id; });

     goalBalls.on('mouseover', goalMouseOver ) 
  	  		   .on('mouseout', goalMouseOut );
    }

    function drawBarchart(dimension,group,withClickMe){

        chartTest = dc.barChart("#chartGoalTeam")
            .dimension(dimension)
            .group(removeEmptyBins(top3Bins(group)))
            .x(d3.scale.ordinal())
            .xUnits(dc.units.ordinal)
            .ordering(function(d) { return -d.value; })
            .barPadding(0.1)
            .outerPadding(0.1)
            .width(417)
            .height(227)
            .colors(colorFnc)
            .on('renderlet', function(chart) {
                chart.selectAll('rect').on("click", function(d) {
                    // chart.selectAll('rect')
                    //   .transition()
                    //   .duration(750)
                    //   .attr("fill","steelblue");

                    // d3.select(this)
                    //   .transition()
                    //   .duration(750)
                    //   .attr("fill","Coral");
                    chart.onClick(d);
                    // ATTENTION: problem if too quick !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    updateGoal(dimension);
                });
            });

        chartTest.margins().bottom = 87;

        chartTest.yAxis().ticks(6);

        chartTest.render();

       // rotates axis
       d3.select("#chartGoalTeam .x.axis").selectAll("text")
       		.style("text-anchor", "end")
       		.attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-47)" );

       if (withClickMe){
	       d3.select("#chartGoalTeam svg").append("image")
	       		.attr("class","elementAbove")
	       		.attr('xlink:href',"img/clickMe.svg")
	       		.attr("x","97")
	       		.attr("y","-16.3")
	       		.attr("width","97")
	       		.attr("height","97");
       	}
        
    }

     function drawMan() {
     	var scaleHue;
     	var whichGradient;
     	var numeratorHeader;
     	var numeratorShot;

	 	/*
	 	//if precomputed
	 	var nGoalHeader =  playerDimension.top(1)[0].goalHeader;
	 	var nShotoffHeader = playerDimension.top(1)[0].shotoffHeader;    
	 	var nShotonHeader = playerDimension.top(1)[0].shotonHeader ;   
	 	var totalHeader = nGoalHeader + nShotoffHeader + nShotonHeader;

	 	var nGoalShot = playerDimension.top(1)[0].goalShot;
	 	var nShotoffShot = playerDimension.top(1)[0].shotoffShot;    
	 	var nShotonShot = playerDimension.top(1)[0].shotonShot ;
	 	var totalShot = nGoalShot + nShotoffShot + nShotonShot;*/
	 	
	 	//HEADERS
	 	var nGoalHeader =  arrayHeader[0].value;
	 	var nShotoffHeader = arrayHeader[1].value;   
	 	var nShotonHeader = arrayHeader[2].value;
	 	var totalHeader = nGoalHeader + nShotoffHeader + nShotonHeader;

	 	//SHOTS
	 	var nGoalShot =  arrayShot[0].value;
	 	var nShotoffShot = arrayShot[1].value;   
	 	var nShotonShot = arrayShot[2].value;
	 	var totalShot = nGoalShot + nShotoffShot + nShotonShot;

	 	if (typePercentage === "goalPercentage") {
	 		scaleHue = goalScaleHue;
	 		whichGradient = "gradientGoal";
	 		numeratorHeader = nGoalHeader ;
	 		numeratorShot = nGoalShot;

	 	} else {
	 		scaleHue = targetScaleHue;
	 		whichGradient = "gradientTarget";
	 		numeratorHeader = nGoalHeader + nShotonHeader;
	 		numeratorShot = nGoalShot + nShotonShot;
	 	}

       
       d3.select("#headerCircle")
         .transition().duration(1077)
         .attr("r", goalScaleRadius(totalHeader))
         .attr("fill", scaleHue((numeratorHeader)/(totalHeader)))
         .attr("opacity", goalScaleTransparency(numeratorHeader/totalHeader));

 
       d3.select("#shotCircle")
         .transition().duration(1077)
         .attr("r", goalScaleRadius(totalShot))
         .attr("fill", scaleHue((numeratorShot)/(totalShot)))
         .attr("opacity", goalScaleTransparency(numeratorShot/totalShot));
   
       	// changes the gradient so that the sacel is shows more differences
       	//d3.select('#silhouette rect').attr("fill", "url(#" + whichGradient + ")");

       	d3.select('#gradientGoal')
       	  .selectAll("stop")
       	  .transition()
       	  .duration(1077)
       	  .attr("stop-color", function (d,i) {return scaleHue(i/11); })
       	  .attr('stop-opacity', function (d,i) {return goalScaleTransparency(i/11); });
       	
       	

    }

    // ##########   UPDATE FUNCTIONS ########## 
    function updatePercentage(){

    	var textPercentage = d3.select('#textPercentage');
    	var textButton = d3.select('#togglePercentage');

    	if (typePercentage  === "goalPercentage") {
    		typePercentage = "targetPercentage";
    		textPercentage.text("Percentage of shots on target").attr("x","23.7%");
    		textButton.text('Goals');


    	} else {
    		typePercentage = "goalPercentage";
    		textPercentage.text("Percentage of goals").attr("x","37.7%");
    		textButton.text('On target');
    	}

    	drawMan();
    }

    function updateHeatMap (dimension){
     	
     	// resets filter for drawing heat map
       dimension.filterAll();
       
       // computes total goal percentage for color
       var goalPercentage =  (arrayHeader[0].value + arrayShot[0].value)/ 
       					  (arrayHeader[0].value + arrayHeader[1].value + arrayHeader[2].value +   
       					   arrayShot[0].value + arrayShot[1].value + arrayShot[2].value)

	  var heatShots = d3.select("#heatShots").selectAll("circle")
	                            .data(dimension.top(Infinity));
	    
	    heatShots.transition().attr("opacity","0");                        
	    heatShots.exit().transition().attr("opacity","0").remove();
	    heatShots.enter().append("circle").attr("opacity","0");
		            
		heatShots.attr("cx", function (d) { return pitchScaleWidth( d.lon); })
		            .attr("cy", function (d) { return pitchScaleHeight(transformHalfPitch(d.lat)); })
		            .attr('r', '7')
		            .attr("pointer-events","none")
		            .attr("fill", goalScaleHue(goalPercentage))
		            .transition()
		            .attr('opacity', '0.17');

			
		// puts back filter for next plots
       dimension.filterExact("goal");

    }

    function updateGoal(dimension, timeTransit = 307){

       var goalBalls = d3.select("#goals").selectAll("image")
                                 .data(dimension.top(Infinity));


      goalBalls.exit().remove();
      goalBalls.enter().append("image")
        .attr("x", pitchScaleWidth(widthPitchReal/2))
        .attr("y", pitchScaleHeight(11));                            

      goalBalls
       .transition()
        .duration(timeTransit)
        .attr('xlink:href',"img/ball.png")
       .attr("x", function (d) { return pitchScaleWidth( d.lon); })
       .attr("y", function (d) { return pitchScaleHeight(transformHalfPitch(d.lat)); })
       .attr('width', '17')
       .attr('height', '17')
       .attr('transform', 'translate(-8.5,-8.5)')
       .attr('opacity', '0.9')
       .attr('id', function (d) { return d.id; });;

      goalBalls.on('mouseover', goalMouseOver ) 
   	  		   .on('mouseout', goalMouseOut );
    }

    function updateHideGoals() {

    	var d3This = d3.select("#toggleHideGoals");
    	
    	if (d3This.text() === "Hide goals" ) {
    		d3This.text("Show Goals");
    		d3.selectAll("#goals image")
    		  .attr("pointer-events","none")
    		  .transition()
    		  .attr("visibility","hidden");

    	} else {
    		d3This.text("Hide goals");
    		d3.selectAll("#goals image")
    		  .attr("pointer-events","auto")
    		  .transition()
    		  .attr("visibility","visible");
    	}

    }

    function updateAll(){
      //resets filter

      //don't show all hover over text
      d3.selectAll(".helpHoverOver").attr("visibility","hidden");

      playerDimension.filterAll();      // get the searched player
      var playerNameSearch = $('#player_search_box').val();

      // Needs to deal with the fact that multiple names could be the same !!!!!!!!!!!!!!!!!!!
      // needs to add autocomplete !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      // should show error if not in array !!!!!
      playerDimension.top(Infinity).forEach( function (player) {
        if (toTitleCase(player.player_name) === toTitleCase(playerNameSearch)){
        	playerID = player.player_api_id;
        	document.getElementById('playerPicture').src = 'http://cdn.sofifa.org/17/players/' + player.player_fifa_api_id + '.png';
        	document.getElementById("playerNameHeader").innerHTML = toTitleCase(player.player_name);
        	document.getElementById("playerHeight").innerHTML = player.height + "cm";
        	document.getElementById("playerWeight").innerHTML = player.weight + "kg";

        }

      });

      // draws the heatmap so take out filtering of type



      playerDimension.filterExact(playerID);
      playerIncDimension.filterExact(playerID);

      drawRadar(playerDimension,averagePlayer);
      
      // STRANE: has to regfroup if not strange things happen !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      teamGroup = againstDimension.group();//.orderNatural();
      drawBarchart(againstDimension,teamGroup,false);

      arrayHeader = typeDimension.group().reduceSum(function(d) { return (d.subtype1==="header");}).all();
      arrayShot = typeDimension.group().reduceSum(function(d) { return !(d.subtype1==="header");}).all();
      drawMan() ;

      updateGoal(typeDimension,750);
      updateHeatMap(typeDimension);


      //if (all_genes.indexOf(search_gene) != -1){
        // zoom and highlight found gene 
        /////////////////////////////////
       // zoom_and_highlight_found_gene(search_gene);
        
      //}
    }

    // ### INTERACTIVE: ON ... FUNCTION ###
    var lastOpacity;
    //var lastPositionMovingText ; //= "86.7%";

    function circleMouseOver (){
    	var d3This = d3.select(this);

    	var nGoal; 
    	var nShoton; 
    	var nShotoff;

    	if (d3This.attr("id") === "headerCircle"){
    		nGoal =  arrayHeader[0].value;
    		nShotoff = arrayHeader[1].value;   
    		nShoton = arrayHeader[2].value;

    	} else ifÂ (d3This.attr("id") === "shotCircle"){
    		nGoal =  arrayShot[0].value;
    		nShotoff = arrayShot[1].value;   
    		nShoton = arrayShot[2].value;

    	}
    	var total = nGoal + nShotoff + nShoton; 

    	var textUnits;
    	var shots;
    	if (typePercentage === "goalPercentage"){
    		textUnits = "goals";
    		shots= (nGoal) ;

    	} else if (typePercentage === "targetPercentage"){
    		textUnits = "On target";
    		shots = (nShoton+nGoal) ;
    	}
    	var percentage = Math.round(1000*shots/total)/10;

    	//lastOpacity = d3This.style("opacity");
    	//var total = Math.round(goalScaleRadius.invert(parseFloat(d3This.attr("r")))).toString();
    	//var percentage = Math.round(1000*goalScaleTransparencyInvert(d3This.style("opacity")))/10; 
    	//lastPositionMovingText = d3.select("#movingPercentage").attr('x'); // if wants to store last
    	var startAxis = parseFloat(d3.select("#silhouette rect").attr("x"));
    	lastOpacity = goalScaleTransparency(percentage/100);

    	d3This.transition()
    		  .attr("opacity","1")
    		  .attr("stroke-width","2px");

    	d3.selectAll(".changeHoverCircle")
    	  .transition()
    	  .attr("visibility", "hidden");

	 	d3.select("#nShotsCircles")
	 	  .transition()
	 	  .text(total)
	 	  .attr("x", (86.7 - 2*total.toString().length) + "%"); // moves to be in the midle
	 	
	 	d3.selectAll(".textCircles").attr("visibility","visible");

	 	d3.select("#movingPercentage")
	 	  .transition()
	 	  .text(percentage + "%")
	 	  .attr("font-weight", "bolder")
	 	  .attr("fill","black")
	 	  .attr("x", startAxis + (89.7-startAxis)*percentage / 100+"%") ;

	 	if (d3This.attr("id") === "shotCircle") {
	 		d3.select("#shotPercentageText").transition().text(shots).attr("font-size", 2.7*Math.sqrt(parseFloat(d3This.style("r"))));
	 		d3.select("#shotPercentageUnit").transition().text(textUnits).attr("font-size", 1.9*Math.sqrt(parseFloat(d3This.style("r"))));
	 	} else {
	 		d3.select("#headerPercentageText").transition().text(shots).attr("font-size", 2.7*Math.sqrt(parseFloat(d3This.style("r"))));
	 		d3.select("#headerPercentageUnit").transition().text(textUnits).attr("font-size", 1.9*Math.sqrt(parseFloat(d3This.style("r"))));
	 	}
	 	
    }

    function circleMouseOut (){
    	d3.select(this)
    	  .transition()
    	  .attr("opacity",lastOpacity)
    	  .attr("stroke-width","0px");

    	d3.selectAll(".changeHoverCircle")
    	  .transition()
    	  .attr("visibility", "visible");

    	d3.selectAll(".textCircles")
    	  .transition()
    	  .attr("visibility","hidden");

    	

    	d3.select("#movingPercentage")
    	  .transition()
    	  .text("100%")
    	  .attr("fill","white")
    	  .attr("font-weight", "normal")
    	  .attr("x", "86.7%") ;
    	  //.attr("x", lastPositionMovingText) ;

    	d3.select("#headerPercentageText").text("");
    	d3.select("#shotPercentageText").text("");
    	d3.selectAll(".textUnits").text("");

    }    

    function goalMouseOver (){
    	var d3This = d3.select(this);
    	d3.selectAll("#goals image").attr("opacity","0.27");
    	d3This.attr("opacity","1");
    	idIncDimension.filterExact(d3This.attr("id"));

    	var arrayGoal = idIncDimension.top(Infinity)[0];
    	d3.select("#vsTextGoals").text(arrayGoal.againstTeam);
    	d3.select("#timeTextGoals").text(arrayGoal.elapsed + ((arrayGoal.elapsed_plus)? "+" + arrayGoal.elapsed_plus : "") + "min");
    	d3.select("#dateTextGoals").text(formatDate(arrayGoal.date));
    	d3.select("#typeTextGoals").text(arrayGoal.subtype1);
    	
    	
	 }
    	 	
    function goalMouseOut (){
    	
    	d3.selectAll("#goals image").transition().attr("opacity","0.9");
    	idIncDimension.filterAll();

    	d3.selectAll("#textGoals text").text("");

    }    

    // ############################# MAIN PROGRAMM #############################

    // ##########  LOAD PLAYER DATA ########## 
    d3.csv("data/player_stats.csv", function(error,player_stats){
      var nPlayers = player_stats.length;

      player_stats.forEach(function(d,i) {
        // folowing found with :
        // head -n 1 soccerKaggle.csv | sed 's/"//g' | awk -F ',' '{ for(i = 1; i <= NF; i++) { print "d."$i,"= +" "d."$i";"; } }'
        d.player_api_id = +d.player_api_id;
        d.player_fifa_api_id = +d.player_fifa_api_id;
        d.date = parseDate(d.date);
        d.overall_rating = +d.overall_rating;
        d.potential = +d.potential;
        d.crossing = +d.crossing;
        d.finishing = +d.finishing;
        d.heading_accuracy = +d.heading_accuracy;
        d.short_passing = +d.short_passing;
        d.volleys = +d.volleys;
        d.dribbling = +d.dribbling;
        d.curve = +d.curve;
        d.free_kick_accuracy = +d.free_kick_accuracy;
        d.long_passing = +d.long_passing;
        d.ball_control = +d.ball_control;
        d.acceleration = +d.acceleration;
        d.sprint_speed = +d.sprint_speed;
        d.agility = +d.agility;
        d.reactions = +d.reactions;
        d.balance = +d.balance;
        d.shot_power = +d.shot_power;
        d.jumping = +d.jumping;
        d.stamina = +d.stamina;
        d.strength = +d.strength;
        d.long_shots = +d.long_shots;
        d.aggression = +d.aggression;
        d.interceptions = +d.interceptions;
        d.positioning = +d.positioning;
        d.vision = +d.vision;
        d.penalties = +d.penalties;
        d.marking = +d.marking;
        d.standing_tackle = +d.standing_tackle;
        d.sliding_tackle = +d.sliding_tackle;
        d.gk_diving = +d.gk_diving;
        d.gk_handling = +d.gk_handling;
        d.gk_kicking = +d.gk_kicking;
        d.gk_positioning = +d.gk_positioning;
        d.gk_reflexes = +d.gk_reflexes;
        d.birthday = parseDate(d.birthday);
        d.height = Math.round(+d.height);
        d.weight = Math.round((+d.weight)*0.453592);

        allNames.push(d.player_name);
       
        for (var key in d) {
          if (i === 0){
            // first loop
            averagePlayer[key] = 0;
          }

          if (d.hasOwnProperty(key) && !isNaN(d[key]) ) {
               averagePlayer[key] += d[key]/nPlayers;
            }
        }
      });
      crossPlayers = crossfilter(player_stats);
      player_stats = null; 
      playerDimension = crossPlayers.dimension(function(d) {return d.player_api_id ;});

      //ex: lewandowski
      playerDimension.filterExact(playerID);
      

      drawRadar(playerDimension,averagePlayer);


      
      // ##########  LOAD INCIDENTS DATA ########## 
      d3.csv("data/incidents.csv", function(error,incidents){

        incidents.forEach(function(d) {
          // folowing found with :
          // head -n 1 soccerKaggle.csv | sed 's/"//g' | awk -F ',' '{ for(i = 1; i <= NF; i++) { print "d."$i,"= +" "d."$i";"; } }'
          d.id = +d.id;
          d.player1 = +d.player1;
          d.player2 = +d.player2;
          d.lon = +d.lon;
          d.lat = +d.lat;
          d.elapsed = +d.elapsed;
          d.elapsed_plus = +d.elapsed_plus;
          d.game_id = +d.game_id;
          d.stage = +d.stage;
          d.date = parseDate(d.date);
          d.home_team_goal = +d.home_team_goal;
          d.away_team_goal = +d.away_team_goal;
          d.isHome = (d.isHome === 'true');
        });

        crossIncidents = crossfilter(incidents);

        playerIncDimension = crossIncidents.dimension(function(d) {return d.player1 ;});
        idIncDimension = crossIncidents.dimension(function(d) {return d.id ;});
        typeDimension = crossIncidents.dimension(function(d) {return d.type ;});
        againstDimension = crossIncidents.dimension(function(d) {return d.againstTeam ;});
        subtypeDimension = crossIncidents.dimension(function(d) {return d.subtype1 ;});
        seasonIncDimension = crossIncidents.dimension(function(d) {return d.season ;});

        teamGroup =  againstDimension.group().orderNatural();

        //ex: lewandowski
        playerIncDimension.filterExact(playerID);
        // ex: 2015/2016
        seasonIncDimension.filterExact(season);
        // only looks at goals for now
        typeDimension.filterExact("goal");
        //subtypeDimension.filterExact("penalty");
        arrayShot = typeDimension.group().reduceSum(function(d) { return !(d.subtype1==="header");}).all();
        arrayHeader = typeDimension.group().reduceSum(function(d) { return (d.subtype1==="header");}).all();
        drawMan();

        drawBarchart(againstDimension,teamGroup,true)

        drawGoals(typeDimension);
        
      });

      // ### AUTO COMPLETE ###
      $("#player_search_box").autocomplete({
      	//shows only 10 results
      	source: function(request, response) {
	        var results = $.ui.autocomplete.filter(allNames, request.term);

	        response(results.slice(0, 10));
    		},
      	selectFirst :true,
		minLength: 4
      });

    });

	// ##########  AFTER LOAD PLAYER DATA ########## 

	// ###### PLAYER SILHOUETTE GRAPH  ######

	// ### AXIS COLOR GRADIENT ###
	// programatically generate the gradient for the legend this creates an array of [percent, colour] pairs as stop values for legend

	// GOAL PERCENTAGE GRADIENT
	var gradient = d3.select('#silhouette').append('defs')
	           .append('linearGradient')
	           .attr('id', 'gradientGoal')
	           .attr('x1', '0%') // from left
	           .attr('y1', '0%')
	           .attr('x2', '100%') // to right
	           .attr('y2', '0%');

	var nStopsColor = 10;
	for(var count = 0; count <= nStopsColor; count++){
		var percentStop = count/nStopsColor;
       gradient.append('stop')
           .attr('offset', 100* percentStop + '%')
           .attr('stop-color', goalScaleHue(percentStop))
           .attr('stop-opacity', goalScaleTransparency(percentStop));
    }

    /*
	// SHOT ON TARGET PERCENTAGE GRADIENT
	var gradient = d3.select('#silhouette').append('defs')
	           .append('linearGradient')
	           .attr('id', 'gradientTarget')
	           .attr('x1', '0%') // from left
	           .attr('y1', '0%')
	           .attr('x2', '100%') // to right
	           .attr('y2', '0%');

	var nStopsColor = 10;
	for(var count = 0; count <= nStopsColor; count++){
		var percentStop = count/nStopsColor;
       gradient.append('stop')
           .attr('offset', 100* percentStop + '%')
           .attr('stop-color', targetScaleHue(percentStop))
           .attr('stop-opacity', goalScaleTransparency(percentStop));
    }*/

    // DRAW AXIS
    // default is goal
    d3.select('#silhouette').append("rect")
          .attr("x", "23%")
          .attr("y", "5.7%")
          .attr("rx", "7")
          .attr("ry", "7")
          .attr("width", "75.7%")
          //.attr("width", "167")
          .attr("height", "13")
          .attr("fill", "url(#gradientGoal)");

    d3.select('#silhouette').append("text")
		  .text("100%")
		  .attr("id", "movingPercentage")
          //.attr("x", "67%")
          .attr("x", "87.7%")
          .attr("y", "9%")
          .attr("font-size", "9")
          .attr("fill", "white");

    //show 3 circle as example
    var circleRadii = [20, 50, 100];
    var minCircleRadii = circleRadii[0];

    d3.select('#circlesLegend').selectAll("circle")
			.data(circleRadii)
			.enter()
			.append("circle")
			.attr("class", function(d,i) { return (i === 2) ? "circleKey" : "circleKey changeHoverCircle"; } )
			.attr("cx", "87%")
          	.attr("cy", "31%")
          	.attr("r", function (d) { return goalScaleRadius(d); })
          	.attr("transform", function (d) { return "translate(" + 0 + "," + -(goalScaleRadius(d)-goalScaleRadius(minCircleRadii)) + ")"; });

    d3.select('#circlesLegend').selectAll("text")
			.data(circleRadii)
			.enter()
			.append("text")
			.text(function(d) { return d ;})
			.attr("class", "changeHoverCircle")
			.attr("x", "85.3%")
			.attr("y", "29.7%")
			.attr("font-size", "8")
			.attr("fill", "grey")
          	.attr("transform", function(d,i) { return "translate(" + -(i===2)*2 + "," + -(goalScaleRadius(d)-goalScaleRadius(minCircleRadii))*1.97 + ")"; });

    d3.select('#circlesLegend').append("text")
    	.text("number of shots")
    	.attr("x", "77.3%")
    	.attr("y", "38.7%")
    	.attr("font-size", "8")
    	.attr("fill", "grey");

    d3.select('#circlesLegend').append("text")
    	.text("7")
    	.attr("id", "nShotsCircles")
    	.attr("class", "textCircles")
    	.attr("x", "84.7%")
    	.attr("y", "25.3%")
    	.attr("font-size", "24")
    	.attr("fill", "grey")
    	.attr("visibility", "hidden");

    d3.select('#circlesLegend').append("text")
    	.text("total shots")
    	.attr("class", "textCircles")
    	.attr("x", "77.7%")
    	.attr("y", "29.3%")
    	.attr("font-size", "13")
    	.attr("fill", "grey")
    	.attr("visibility", "hidden");

       	d3.selectAll(".circleHover")
   	  .on('mouseover', circleMouseOver ) 
   	  .on('mouseout', circleMouseOut );


   	// ###### UPDATE SEASON ######
   	$(function() {
   	  $('#selectYear').on('change', function(){
   	  	// takes out blue around
   	  	$(this).blur();
   	    season = $(this).find("option:selected").val();

   	    if (season === "All"){
   	    	// resets filter so that thakes all into account
   	    	seasonIncDimension.filterAll();
   	    } else {
   	    	seasonIncDimension.filterExact(season);
   	    }
   	    updateAll();
   	  });
   	  
   	});

   	// ###### UPDATE POSITION SHOTS ######
   	/*
   	$(function() {
   	  $('#selectPositionShots').on('change', function(){
   	  	// takes out blue around
   	  	$(this).blur();
   	    typeShots = $(this).find("option:selected").val();

   	    if (typeShots === "All"){
   	    	// resets filter so that thakes all into account
   	    	seasonIncDimension.filterAll();
   	    } else if (typeShots === "Goals"){
   	    	typeDimension.filterExact("goal");
   	    } else if (typeShots === "Off target"){
   	    	typeDimension.filterExact("shotoff");
   	    } else if (typeShots === "Blocked Shots"){
   	    	typeDimension.filterExact("shoton");
   	    }
   	    
   	  });
   	  
   	});*/

   	// ###### UPDATE RADAR ######
   	
   	$(function() {
   	  $('#selectRadar').on('change', function(){
   	  	// takes out blue around
   	  	$(this).blur();
   	    typeRadar = $(this).find("option:selected").val();
   	    drawRadar(playerDimension,averagePlayer);
   	    
   	  });
   	  
   	});


   	// ###### UPDATE PLAYER ######

   	// submit player button 
   	$("#player_search_box").keyup(function (e) {
   	      // if pressed enter or return
   	      if (e.keyCode == 13) {
   	          // Do something
   	          // console.log('pressed enter');
   	          updateAll();
   	      }
   	  });

    </script>

  </body>
</html>